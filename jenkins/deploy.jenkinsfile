pipeline {
    agent any

    parameters {
        string(name: 'GITHUB_REPO', defaultValue: 'SIDHARTH27163/ERP_SPRINGBOOT_APIs', description: 'GitHub Repository Name')
        choice(name: 'BRANCH', choices: ['main', 'dev', 'feature'], description: 'Select the branch to checkout')  
    }

    environment {
        IMAGE_NAME = "springboot-container"
        VERSION = "1.0.${BUILD_NUMBER}"                      // ‚úÖ Versioning
        BACKUP_VERSION = "backup-${BUILD_NUMBER - 1}"        
    }

    stages {

        stage('Clean Workspace') {
            steps {
                echo "üßπ Cleaning Workspace..."
                cleanWs()  // ‚úÖ Clean before cloning
            }
        }

        stage('Clone Repo') {
            steps {
                echo "üì• Cloning repository from GitHub: ${GITHUB_REPO} - Branch: ${BRANCH}"
                script {
                    sh """
                    git clone -b ${BRANCH} https://github.com/${GITHUB_REPO}.git 
                    """
                }
            }
        }

        stage('Build with Maven') {
            steps {
                script {
                    echo "üî® Running Maven Build: mvn clean install"
                    
                    // ‚úÖ Navigate to repo folder and run mvn build
                    sh """
              
                    mvn clean install
                    """
                }
            }
        }

        stage('Build Docker Image') {
            steps {
                script {
                    echo "üê≥ Building Docker Image: ${IMAGE_NAME}:${VERSION}"

                    // ‚úÖ Build Docker image after mvn build
                    sh """
                 
                    docker build -t ${IMAGE_NAME}:${VERSION} .
                    """
                }
            }
        }

        stage('Backup Existing Container') {
            steps {
                script {
                    echo "üì¶ Creating Backup of Current Container"

                    // ‚úÖ Backup current container
                    sh """
                    docker-compose down || echo "No running container"
                    docker tag ${IMAGE_NAME}:latest ${IMAGE_NAME}:${BACKUP_VERSION} || echo "No backup available"
                    """
                }
            }
        }

        stage('Deploy New Image') {
            steps {
                script {
                    echo "üöÄ Deploying new Docker image..."

                    // ‚úÖ Deploy updated image
                    sh """
            
                    sed -i "s|image:.*|image: ${IMAGE_NAME}:${VERSION}|" docker-compose.yml
                    docker-compose up -d
                    """
                }
            }
        }

        stage('Post-Deployment Cleanup') {
            steps {
                script {
                    echo "üßπ Cleaning up old Docker images..."

                    // ‚úÖ Clean old images
                    sh '''
                    docker image prune -f
                    docker rmi -f ${IMAGE_NAME}:${BACKUP_VERSION} || true
                    '''
                }
            }
        }

        stage('Rollback on Failure') {
            steps {
                script {
                    echo "üîÑ Checking for Rollback..."

                    // ‚úÖ Rollback on failure
                    sh """
                    if [ \${?} -ne 0 ]; then
                        echo "üö® Deployment failed, rolling back..."
                        docker tag \${IMAGE_NAME}:\${BACKUP_VERSION} \${IMAGE_NAME}:latest
                        docker-compose up -d
                    fi
                    """
                }
            }
        }
    }

    post {
        success {
            echo "‚úÖ Deployment completed successfully!"
        }
        failure {
            echo "‚ùå Deployment failed. Rolling back..."
        }
    }
}
